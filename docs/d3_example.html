<!DOCTYPE html>
<head>
</head>
<style>

.counties {
  fill: none;
  fill-opacity:.5;
  stroke: #fff;
  stroke-width: 2px;
  stroke-miterlimit: 2;
  stroke-linejoin: round;
  stroke-linecap: round;
}

#_viz_map_container {
  display: inline-block;
}

</style>
<body>
  <div id="_viz_map_container"></div>
</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script>

// ---- Utility Functions ----

function addDropShadowFilter(svg, stddev=3, xoffset=5, yoffset=5) {
  // adapted from http://bl.ocks.org/cpbotha/5200394

  // filters go in defs element
  var defs = svg.append("defs");

  // create filter with id #drop-shadow
  // height=130% so that the shadow is not clipped
  var filter = defs.append("filter")
      .attr("id", "drop-shadow")
      .attr('y', '-40%')
      .attr('x', '-40%')
      .attr("height", "200%")
      .attr("width", "200%");

  // SourceAlpha refers to opacity of graphic that this filter will be applied to
  // convolve that with a Gaussian with standard deviation 3 and store result
  // in blur
  filter.append("feGaussianBlur")
      .attr("in", "SourceAlpha")
      .attr("stdDeviation", stddev)
      .attr("result", "blur");

  // translate output of Gaussian blur to the right and downwards with 2px
  // store result in offsetBlur
  filter.append("feOffset")
      .attr("in", "blur")
      .attr("dx", xoffset)
      .attr("dy", yoffset)
      .attr("result", "offsetBlur");

  // overlay original SourceGraphic over translated blurred opacity by using
  // feMerge filter. Order of specifying inputs is important!
  var feMerge = filter.append("feMerge");

  feMerge.append("feMergeNode")
      .attr("in", "offsetBlur")
  feMerge.append("feMergeNode")
      .attr("in", "SourceGraphic");

}

// ----- Map Constants -------

// the indices of this list align with the "region_id" attribute in the topojson file(s)
const REGION_COLORS = [  
  "#1f77b4",
  "#aec7e8",
  "#ff7f0e",
  "#ffbb78",
  "#2ca02c",
  "#98df8a",
  "#d62728",
  "#ff9896",
  "#9467bd",
  "#c5b0d5",
  "#8c564b",
  "#c49c94",
  "#e377c2",
  "#f7b6d2",
  "#bcbd22",
  "#dbdb8d",
  "#17becf",
  "#9edae5",
];

// increases size of region on click/hover/whatever
const REGION_POP_SCALER = 1.01;

const CA_COUNTIES_REGIONS_TOPOJSON_URL = "https://raw.githubusercontent.com/austinorr/ca_metrics/master/data/ca-counties.json"

// ------------

var ca_svg = d3.select("#_viz_map_container")
      .append('svg')
      .attr('width', 600)
      .attr('height', 600),

  width = ca_svg.attr('width'),
  height = ca_svg.attr('height');


var projection = d3.geoConicEqualArea()
  .parallels([34, 40.5])
  .rotate([120, 0])

var path = d3.geoPath()
  .projection(projection);

function sortSvgGroupElements(svg, property) {
  svg.selectAll('g').sort(function(a, b) {
    if (a.properties[property] != b.properties[property]) return -1;
      else return 1;
  })
}

function equalToEventTarget() {
  // console.log(d3.event.target)
  return this == d3.event.target;
}

function clear_selection() {
  ca_svg.selectAll("#countySelected").remove();
}

d3.select("body").on("click", function(){

    var outside = !ca_svg.filter(equalToEventTarget).empty();
    if ( outside ) {
        clear_selection();
    }
});

function region_clicked() {

  clear_selection()

  var bbox = d3.select(this).node().getBBox(),
      region_id = d3.select(this).data()[0].properties.region_id,
      cx = bbox.x + bbox.width / 2,
      cy = bbox.y + bbox.height / 2,
      scaler = REGION_POP_SCALER,
      color = d3.select(this).style('fill'),
      selected_region = ca_svg.select(".counties.region_"+region_id);

  shadow = selected_region.clone(true)
  pop_region = selected_region.clone(true)
  addDropShadowFilter(shadow, 5, 0, 0)

  shadow
    .attr('id', 'countySelected')
    .raise()
    .style('color', color)
    .style('opacity', .8)
    .style("filter", "url(#drop-shadow)");


  pop_region
    .attr('id', 'countySelected')
    .raise()
    .style('fill', color)
    .style('fill-opacity', 1)
    .transition()
      .duration(50)
      .attr(
        "transform", 
        "translate(" + (1-scaler) * cx + ", " + (1-scaler) * cy + ") scale(" + scaler + ")");

}

function getMaxProperty(features_array, property) {
  var max_prop = null;
  for (var i=0; i<features_array.length; i++) {
    var f = features_array[i].properties
    if (f[property] > max_prop) {
      max_prop = f[property]
    }
  }
  return max_prop
}

d3.json(CA_COUNTIES_REGIONS_TOPOJSON_URL, function(error, ca) {
  if (error) throw error;

  var feature_obj = topojson.feature(ca, ca.objects.data)
  var pad = 20

  projection.fitExtent([[pad, pad], [width-pad, height-pad]], feature_obj)

  var nRegions = getMaxProperty(feature_obj.features, 'region_id');

  for (var i=0; i<nRegions; i++) {
    region_features = feature_obj.features.filter(d => d.properties.region_id == i);
    ca_svg.append("g")
      .attr("class", "counties region_"+i)
      .selectAll("path")
      .data(region_features)
      .enter().append("path")
        .attr("d", path)
        .style("fill", (d) => REGION_COLORS[d.properties.region_id])
        .on("click", region_clicked);
  }

  let hoverEnabled = false;
  ca_svg.on('mousedown', x => hoverEnabled = true)
    .on('mouseup', x => hoverEnabled = false)
  ca_svg.selectAll('.counties path').on('mouseover', function() {
    if (hoverEnabled) {
      this.classList.add('hovered');
    }
  });
  
});
</script>